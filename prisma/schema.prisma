generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  firebaseUid String   @unique
  email       String   @unique
  name        String?
  image       String?  // Deprecated? Or migrate to profileImageUrl? User asked for profileImageUrl.
  profileImageUrl String?
  role        String   @default("student")
  plan        String?  @default("free") // "free", "pro", "elite"
  subscriptionStatus String? // "active", "canceled", "past_due"
  stripeCustomerId String?
  stripeSubscriptionId String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  certificates Certificate[]
  quizAttempts QuizAttempt[]
  enrollments Enrollment[]
  learningPaths UserLearningPath[]

  // --- Student Profile Expansion ---
  headline        String?
  bio             String? 
  
  // Contact & Location
  country         String?
  state           String?
  city            String?
  phone           String?
  language        String? 
  
  // Socials
  linkedinProfile String?
  twitterProfile  String?
  githubProfile   String?
  website         String?
  
  // Education
  qualification   String? 
  degree          String? 
  college         String?
  graduationYear  String?
  
  // Career Intent
  careerStatus    String? 
  targetRole      String? 
  
  // Skills
  skills          String[] 

  progress        UserProgress[]
  subscription    Subscription?
}


model Course {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  slug        String   @unique
  title       String
  description String?
  thumbnailUrl String?
  thumbnail   String? // Keep for potential backward compat or migrate
  price       Float    @default(0) // Should be 0 always as per new rule
  published   Boolean  @default(false)
  
  lessons     Lesson[]
  quizzes     Quiz[]   // Both lesson quizzes and final quiz

  // Marketing & Filter fields
  categoryId  String?  @db.ObjectId
  category    CourseCategory? @relation(fields: [categoryId], references: [id])
  
  // Tags (Simple array of strings)
  tags        String[]

  difficulty  String?  // Beginner, Intermediate, Advanced
  duration    String?  
  rating      Float    @default(0)

  // Instructor Info
  instructorName        String?
  instructorChannelName String?

  certificateType String @default("BASIC") // "BASIC", "PREMIUM"
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Soft Delete
  deletedAt   DateTime?

  enrollments Enrollment[]
  learningPathNodes LearningPathNodeCourse[]
  userProgress UserProgress[]
}

model ContactMessage {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  email     String
  subject   String
  message   String
  createdAt DateTime @default(now())
}


model CourseCategory {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  name      String   @unique
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  courses   Course[]
}


model Certificate {
  id             String   @id @default(auto()) @map("_id") @db.ObjectId
  credentialId   String   @unique
  userId         String   @db.ObjectId
  courseId       String   
  
  imageUrl       String?
  pdfUrl         String?
  
  // Snapshots
  studentName    String
  courseName     String
  instructorName String
  
  // Mapped to 'tier' in DB for backward compatibility, but we use 'certificateType' in code
  certificateType String   @map("tier") 
  
  issueDate      DateTime @default(now())
  createdAt      DateTime @default(now())
  
  user           User     @relation(fields: [userId], references: [id])
}

model LearningPath {
  id             String   @id @default(auto()) @map("_id") @db.ObjectId
  title          String
  slug           String   @unique
  description    String?
  certificateType String  @default("BASIC") // "BASIC", "PREMIUM"
  published      Boolean  @default(false)
  duration       Int?     // Estimated duration in hours (optional, admin-set)
  
  nodes          LearningPathNode[]
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  userLearningPaths UserLearningPath[]
}

model LearningPathNode {
  id             String   @id @default(auto()) @map("_id") @db.ObjectId
  learningPathId String   @db.ObjectId
  title          String
  description    String?
  order          Int
  type           String   @default("core") // core, optional, advanced
  difficulty     String   @default("Beginner") // Beginner, Intermediate
  
  learningPath   LearningPath @relation(fields: [learningPathId], references: [id], onDelete: Cascade)
  courses        LearningPathNodeCourse[]
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model LearningPathNodeCourse {
  id             String   @id @default(auto()) @map("_id") @db.ObjectId
  nodeId         String   @db.ObjectId
  courseId       String   @db.ObjectId // Manual relation or strict? Strict is better.
  
  node           LearningPathNode @relation(fields: [nodeId], references: [id], onDelete: Cascade)
  course         Course           @relation(fields: [courseId], references: [id])
  
  @@unique([nodeId, courseId])
}

model Quiz {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  courseId    String   @db.ObjectId
  lessonId    String?  @db.ObjectId @unique // One quiz per lesson max
  title       String
  type        String   @default("LESSON_QUIZ") // "LESSON_QUIZ", "FINAL_QUIZ"
  questions   Json
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  course      Course   @relation(fields: [courseId], references: [id])
  lesson      Lesson?  @relation(fields: [lessonId], references: [id])
  attempts    QuizAttempt[]
}

model QuizAttempt {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  quizId      String   @db.ObjectId
  userId      String   @db.ObjectId
  score       Float
  passed      Boolean
  completedAt DateTime @default(now())
  
  user        User     @relation(fields: [userId], references: [id])
  quiz        Quiz     @relation(fields: [quizId], references: [id])
}

model Plan {
  id               String   @id @default(auto()) @map("_id") @db.ObjectId
  key              String   @unique 
  name             String
  price            String
  originalPrice    String?
  sellingPrice     Float
  originalPriceNum Float
  period           String
  description      String
  features         String[]
  popular          Boolean  @default(false)
  users            Int      @default(0) 
  percentage       Int      @default(0) 
  color            String?  
  
  updatedAt        DateTime @updatedAt
}

model Subscription {
  id                   String   @id @default(auto()) @map("_id") @db.ObjectId
  userId               String   @db.ObjectId @unique
  plan                 String   @default("FREE") // FREE, PRO, ELITE
  status               String   @default("ACTIVE") // ACTIVE, CANCELLED, PAST_DUE
  startDate            DateTime @default(now())
  endDate              DateTime?
  stripeCustomerId     String?
  stripeSubscriptionId String?
  
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Enrollment {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  userId      String   @db.ObjectId
  courseId    String   @db.ObjectId
  progress    Int      @default(0)
  status      String   @default("in-progress") // "in-progress", "completed"
  startedAt   DateTime @default(now())
  completedAt DateTime?
  lastAccessedAt DateTime @default(now())
  
  user        User     @relation(fields: [userId], references: [id])
  course      Course   @relation(fields: [courseId], references: [id])

  @@unique([userId, courseId])
}

model UserLearningPath {
  id             String   @id @default(auto()) @map("_id") @db.ObjectId
  userId         String   @db.ObjectId
  learningPathId String   @db.ObjectId
  progress       Int      @default(0)
  status         String   @default("in-progress") // "in-progress", "completed"
  startedAt      DateTime @default(now())
  completedAt    DateTime?
  
  user           User     @relation(fields: [userId], references: [id])
  learningPath   LearningPath @relation(fields: [learningPathId], references: [id], onDelete: Cascade)
  
  completedNodeIds String[] @default([])

  @@unique([userId, learningPathId])
}

model Lesson {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  courseId    String   @db.ObjectId
  title       String
  description String?
  mediaUrl    String?
  videoUrl    String?
  order       Int      @default(0)
  published   Boolean  @default(false)
  
  course      Course   @relation(fields: [courseId], references: [id])
  quiz        Quiz?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  userProgress UserProgress[]
}

model CMSPage {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  slug      String   @unique
  title     String
  content   String
  status    String   @default("draft") // "published", "draft"
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())
  publishedAt DateTime?
}

model UserProgress {
  id                String    @id @default(auto()) @map("_id") @db.ObjectId
  userId            String    @db.ObjectId
  courseId          String    @db.ObjectId
  lessonId          String    @db.ObjectId
  watchedPercentage Int       @default(0)
  completed         Boolean   @default(false)
  completedAt       DateTime?
  updatedAt         DateTime  @updatedAt

  user   User   @relation(fields: [userId], references: [id])
  course Course @relation(fields: [courseId], references: [id])
  lesson Lesson @relation(fields: [lessonId], references: [id])

  @@unique([userId, lessonId])
  @@index([userId, courseId])
}
